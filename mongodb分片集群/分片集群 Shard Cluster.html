<html>
<head>
  <title>分片集群 Shard Cluster</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/606060 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="937"/>
<h1>分片集群 Shard Cluster</h1>

<div>
<span><div><div><div><span style="font-weight: bold;">什么是分片</span></div><div>分片(sharding) 是MongoDB用来将大型集合水平分割到不同服务器(或者复制集)上所采用的方法。不需要功能强大的大型计算机就可以存储更多的数据，处理更大的负载</div><div><br/></div><div><span style="font-weight: bold;">为什么要分片</span></div><ul><li><div>存储容量需求超出单机磁盘容量</div></li><li><div>活跃的数据集超出单机内存容量，导致很多请求都要从磁盘读取数据，影响性能</div></li><li><div>IOPS超出的那个MongoDB节点的服务能力，随着数据的增长，单机实例的瓶颈会越来越明显</div></li><li><div>副本集具有节点数量限制</div></li></ul><div><br/></div><div>垂直扩展：增加更多的CPU和存储资源来扩展容量</div><div>水平扩展：将数据集分布在多个服务器上，水平扩展即分片</div><div><br/></div><div><span style="font-weight: bold;">分片工作原理</span></div><div><img src="分片集群 Shard Cluster_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>分片集群由以下3个服务组成</div><ul><li><div>Shards Server：每个shard由一个或多个mongod进程组成，用于存储数据</div></li><li><div>Route Server：数据库集群的请求入口，所有请求都通过Route(mongos)进行协调，不需要在应用程序添加一个路由选择器，就是一个请求分发中心，它负责把应用程序的请求转发到对应的shard服务器</div></li><li><div>Config Server：配置服务器。存储所有数据库元信息(路由、分片)的配置</div></li></ul><div><br/></div><div><span style="font-weight: bold;">片键(shard key)</span>：为了在数据集合中分配文档，MongoDB使用分片主键分割集合</div><div><span style="font-weight: bold;">区块(Chunk)</span>：在一个Shards Server内部，MongoDB还是会把数据分为区块chunk，每个chunk代表这个Shards Server内部一部分数据，包含基于分片主键的左闭右开的区间范围chunk</div><div><br/></div><div><span style="font-weight: bold;">分片策略</span></div><div>无非从两个方面考虑，数据的查询和写入，关键在于权衡性能和负载</div><div>最好的效果：</div><ul><li><div>数据查询时能命中更少的分片</div></li><li><div>数据写入时能够随机的写入每个分片</div></li></ul><div><br/></div><div>数据库中没有合适的Shard Key供选择，或者使用Shard Key基数太小，即变化少（如星期，只有七天可变化），可以选择组合片键(A+B),甚至可以添加冗余字段组合。一般是粗粒度+细粒度进行组合</div><div><br/></div><div><span style="font-weight: bold;">范围分片</span></div><div><img src="分片集群 Shard Cluster_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div></div><ul><li><div>范围分片是基于分片Shard Key的值切分数据，每一个chunk将会分配到一个范围</div></li><li><div>范围分片适合满足在一定范围内的查找</div></li><li><div>例如：查找X的值在[20,30)之间的数据，mongo路由根据Config Server中存储的元数据，直接定位到指定的Shards的chunk</div></li><li><div>缺点：如果Shard Key有明显递增（或者递减）趋势，则新插入的文档多会分布到同一个chunk，所以并发写入会出现明显瓶颈</div></li></ul><div><br/></div><div><span style="font-weight: bold;">hash分片</span></div><div><img src="分片集群 Shard Cluster_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><ul><li><div>Hash分片是计算一个分片Shard key的hash值，每一个区块将分配一个范围的hash值</div></li><li><div>Hash分片与范围分片互补，能将文档随机的分散到各个chunk，充分的利用分布式写入能力，弥补范围分片的不足</div></li><li><div>缺点：范围查询性能不佳。所有范围查询要分发到后端所有的shard才能找到满足条件的文档</div></li></ul><div><br/></div><div><span style="font-weight: bold;">分片集群的搭建</span></div><div><img src="分片集群 Shard Cluster_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="font-weight: bold;">下载mongodb</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 1.下载社区版 MongoDB 4.1.3</div><div>#   下载地址：https://www.mongodb.com/download-center#community</div><div>wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.1.3.tgz</div><div># 2.将压缩包解压即可</div><div>mkdir /usr/local/zhang/</div><div>tar -zxvf mongodb-linux-x86_64-rhel70-4.1.3.tgz -C /usr/local/zhang/</div><div>mv /usr/local/zhang/mongodb-linux-x86_64-rhel70-4.1.3 /usr/local/zhang/mongodb</div></div><div><br/></div><div><span style="font-weight: bold;">配置服务节点集群</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 初始化集群数据文件存储目录和日志文件</div><div>mkdir -p /usr/local/zhang/mongodb/config1</div><div>mkdir -p /usr/local/zhang/mongodb/config2</div><div>mkdir -p /usr/local/zhang/mongodb/config3</div><div># 初始化日志文件</div><div>touch /usr/local/zhang/mongodb/logs/config1.log</div><div>touch /usr/local/zhang/mongodb/logs/config2.log</div><div>touch /usr/local/zhang/mongodb/logs/config3.log</div><div># 创建集群配置文件目录</div><div>mkdir /usr/local/zhang/mongodb/conf</div></div><div><br/></div><div>配置服务 节点1 config-17017.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/config-17017.conf &lt;&lt;-'EOF'</div><div># 数据库文件位置</div><div>dbpath=/usr/local/zhang/mongodb/config1</div><div>#日志文件位置</div><div>logpath=/usr/local/zhang/mongodb/logs/config1.log</div><div># 以追加方式写入日志</div><div>logappend=true</div><div># 是否以守护进程方式运行</div><div>fork = true</div><div>bind_ip=0.0.0.0</div><div>port = 17017</div><div># 表示是一个配置服务器</div><div>configsvr=true</div><div>#配置服务器副本集名称</div><div>replSet=configsvr</div><div>EOF</div></div><div><br/></div></div><div><b>配置服务 节点2 config-17018.conf</b></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee  /usr/local/zhang/mongodb/conf/config-17018.conf &lt;&lt;-'EOF'<br/></div><div># 数据库文件位置</div><div>dbpath=/usr/local/zhang/mongodb/config2</div><div>#日志文件位置</div><div>logpath=/usr/local/zhang/mongodb/logs/config2.log</div><div># 以追加方式写入日志</div><div>logappend=true</div><div># 是否以守护进程方式运行</div><div>fork = true</div><div>bind_ip=0.0.0.0</div><div>port = 17018</div><div># 表示是一个配置服务器</div><div>configsvr=true</div><div>#配置服务器副本集名称</div><div>replSet=configsvr</div><div>EOF</div></div><div><br/></div><div><span style="font-weight: bold;">配置服务 节点3 config-17019.conf</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/config-17019.conf &lt;&lt;-'EOF'</div><div># 数据库文件位置</div><div>dbpath=/usr/local/zhang/mongodb/config3</div><div>#日志文件位置</div><div>logpath=/usr/local/zhang/mongodb/logs/config3.log</div><div># 以追加方式写入日志</div><div>logappend=true</div><div># 是否以守护进程方式运行</div><div>fork = true</div><div>bind_ip=0.0.0.0</div><div>port = 17019</div><div># 表示是一个配置服务器</div><div>configsvr=true</div><div>#配置服务器副本集名称</div><div>replSet=configsvr</div><div>EOF</div></div><div><br/></div><div><b>启动配置服务集群脚本</b></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/start-mongo-config.sh &lt;&lt;-'EOF'</div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/config-17017.conf</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/config-17018.conf</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/config-17019.conf</div><div>echo &quot;start mongo config cluster...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div>chmod 755 /usr/local/zhang/mongodb/start-mongo-config.sh</div></div><div><br/></div><div><b>关闭配置服务集群脚本</b></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/stop-mongo-config.sh  &lt;&lt;-'EOF'</div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/config-17017.conf</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/config-17018.conf</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/config-17019.conf</div><div>echo &quot;stop mongo config cluster...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div>chmod 755 /usr/local/zhang/mongodb/stop-mongo-config.sh</div></div><div><br/></div><div>进入任意节点的mongo shell 并添加 配置节点集群</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/usr/local/zhang/mongodb4.1.3/bin/mongo --</div><div>host=192.168.48.130 --port=17017</div><div><br/></div><div><br/></div><div><br/></div><div>use admin</div><div>var cfg ={&quot;_id&quot;:&quot;configsvr&quot;,</div><div>        &quot;members&quot;:[</div><div>            {&quot;_id&quot;:1,&quot;host&quot;:&quot;192.168.48.130:17017&quot;},</div><div>            {&quot;_id&quot;:2,&quot;host&quot;:&quot;192.168.48.130:17018&quot;},</div><div>            {&quot;_id&quot;:3,&quot;host&quot;:&quot;192.168.48.130:17019&quot;}]</div><div>        };</div><div>rs.initiate(cfg)</div><div>rs.status()</div></div><div><br/></div><div><br/></div><div><br/></div><div><b>配置shard1 和 shard2 集群</b></div><div><br/></div><div>shard1集群搭建37017到37019的端口</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mkdir -p /usr/local/zhang/mongodb/datashard/server1</div><div>mkdir -p /usr/local/zhang/mongodb/datashard/server2</div><div>mkdir -p /usr/local/zhang/mongodb/datashard/server3</div><div><br/></div><div>mkdir /usr/local/zhang/mongodb/logs/datashard</div><div>touch /usr/local/zhang/mongodb/logs/server1.log</div><div>touch /usr/local/zhang/mongodb/logs/server2.log</div><div>touch /usr/local/zhang/mongodb/logs/server3.log</div><div><br/></div><div>mkdir /usr/local/zhang/mongodb/conf</div></div><div><br/></div><div>shard1 主节点配置mongo_37017.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/mongo_37017.conf &lt;&lt;-'EOF'</div><div># 主节点配置</div><div>dbpath=/usr/local/zhang/mongodb/datashard/server1</div><div>bind_ip=0.0.0.0</div><div>port=37017</div><div>fork=true</div><div>logpath=/usr/local/zhang/mongodb/logs/datashard/server1.log</div><div># 集群名称</div><div>replSet=shard1</div><div>shardsvr=true</div><div>EOF</div></div><div><br/></div><div>shard1 从节点1配置mongo_37018.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/mongo_37018.conf &lt;&lt;-'EOF'</div><div>dbpath=/usr/local/zhang/mongodb/datashard/server2</div><div>bind_ip=0.0.0.0</div><div>port=37018</div><div>fork=true</div><div>logpath=/usr/local/zhang/mongodb/logs/datashard/server2.log</div><div>replSet=shard1</div><div>shardsvr=true</div><div>EOF</div></div><div><br/></div><div>shard1 从节点2配置mongo_37019.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/mongo_37019.conf &lt;&lt;-'EOF'</div><div>dbpath=/usr/local/zhang/mongodb/datashard/server3</div><div>bind_ip=0.0.0.0</div><div>port=37019</div><div>fork=true</div><div>logpath=/usr/local/zhang/mongodb/logs/datashard/server3.log</div><div>replSet=shard1</div><div>shardsvr=true</div><div>EOF</div></div><div><br/></div><div>shard1启动集群脚本</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/start-mongo-shard1.sh &lt;&lt;-'EOF'</div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/mongo_37017.conf</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/mongo_37018.conf</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/mongo_37019.conf</div><div>echo &quot;start mongo shard1 cluster...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div><br/></div><div><br/></div><div>chmod 755 /usr/local/zhang/mongodb/start-mongo-shard1.sh</div></div><div><br/></div><div>shard1关闭集群脚本</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/stop-mongo-shard1.sh &lt;&lt;-'EOF'</div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/mongo_37017.conf</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/mongo_37018.conf</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/mongo_37019.conf</div><div>echo &quot;stop mongo shard1 cluster...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div>chmod 755 /usr/local/zhang/mongodb/stop-mongo-shard1.sh</div></div><div><br/></div><div>初始化shard1集群命令</div><div>启动三个节点，然后进入primary节点 运行如下命令</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/usr/local/zhang/mongodb/bin/mongo --host=192.168.48.129 --port=37017</div><div><br/></div><div>var cfg ={&quot;_id&quot;:&quot;shard1&quot;,</div><div>            &quot;protocolVersion&quot; : 1,</div><div>            &quot;members&quot;:[</div><div>                {&quot;_id&quot;:1,&quot;host&quot;:&quot;192.168.48.129:37017&quot;},</div><div>                {&quot;_id&quot;:2,&quot;host&quot;:&quot;192.168.48.129:37018&quot;},</div><div>                {&quot;_id&quot;:3,&quot;host&quot;:&quot;192.168.48.129:37019&quot;}</div><div>            ]</div><div>        }</div><div>rs.initiate(cfg)</div><div>rs.status()</div></div><div><br/></div><div>shard2集群搭建47017到47019</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mkdir -p /usr/local/zhang/mongodb/datashard/server4</div><div>mkdir -p /usr/local/zhang/mongodb/datashard/server5</div><div>mkdir -p /usr/local/zhang/mongodb/datashard/server6</div><div><br/></div><div><br/></div><div>mkdir /usr/local/zhang/mongodb/logs/datashard</div><div>touch /usr/local/zhang/mongodb/logs/server4.log</div><div>touch /usr/local/zhang/mongodb/logs/server5.log</div><div>touch /usr/local/zhang/mongodb/logs/server6.log</div><div><br/></div><div><br/></div><div>mkdir /usr/local/zhang/mongodb/conf</div></div><div><br/></div><div>shard2 主节点配置mongo_47017.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/mongo_47017.conf &lt;&lt;-'EOF'</div><div># 主节点配置</div><div>dbpath=/usr/local/zhang/mongodb/datashard/server4</div><div>bind_ip=0.0.0.0</div><div>port=47017</div><div>fork=true</div><div>logpath=/usr/local/zhang/mongodb/logs/datashard/server4.log</div><div># 集群名称</div><div>replSet=shard2</div><div>shardsvr=true</div><div>EOF</div></div><div><br/></div><div>shard2 从节点1配置mongo_47018.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/mongo_47018.conf &lt;&lt;-'EOF'</div><div>dbpath=/usr/local/zhang/mongodb/datashard/server5</div><div>bind_ip=0.0.0.0</div><div>port=47018</div><div>fork=true</div><div>logpath=/usr/local/zhang/mongodb/logs/datashard/server5.log</div><div>replSet=shard2</div><div>shardsvr=true</div><div>EOF</div></div><div><br/></div><div>shard2从节点2配置mongo_47019.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/mongo_47019.conf &lt;&lt;-'EOF'</div><div>dbpath=/usr/local/zhang/mongodb/datashard/server6</div><div>bind_ip=0.0.0.0</div><div>port=47019</div><div>fork=true</div><div>logpath=/usr/local/zhang/mongodb/logs/datashard/server6.log</div><div>replSet=shard2</div><div>shardsvr=true</div><div>EOF</div></div><div><br/></div><div>配置shard2启动脚本</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/start-mongo-shard2.sh &lt;&lt;-'EOF'</div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/mongo_47017.conf</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/mongo_47018.conf</div><div>/usr/local/zhang/mongodb/bin/mongod -f /usr/local/zhang/mongodb/conf/mongo_47019.conf</div><div>echo &quot;start mongo shard2 cluster...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div><br/></div><div><br/></div><div>chmod 755 /usr/local/zhang/mongodb/start-mongo-shard2.sh</div></div><div><br/></div><div>配置shard2关闭脚本</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/stop-mongo-shard2.sh &lt;&lt;-'EOF'<br/></div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/mongo_47017.conf</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/mongo_47018.conf</div><div>/usr/local/zhang/mongodb/bin/mongod --shutdown -f /usr/local/zhang/mongodb/conf/mongo_47019.conf</div><div>echo &quot;stop mongo shard2 cluster...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div>chmod 755 /usr/local/zhang/mongodb/stop-mongo-shard2.sh</div></div><div><br/></div><div>初始化shard2集群命令</div><div>启动三个节点，然后进入primary节点，运行如下命令</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/usr/local/zhang/mongodb/bin/mongo --host=192.168.48.128 --port=47017</div><div><br/></div><div>var cfg ={&quot;_id&quot;:&quot;shard2&quot;,</div><div>            &quot;protocolVersion&quot; : 1,</div><div>            &quot;members&quot;:[</div><div>                {&quot;_id&quot;:1,&quot;host&quot;:&quot;192.168.48.128:47017&quot;},</div><div>                {&quot;_id&quot;:2,&quot;host&quot;:&quot;192.168.48.128:47018&quot;},</div><div>                {&quot;_id&quot;:3,&quot;host&quot;:&quot;192.168.48.128:47019&quot;}</div><div>            ]</div><div>        }</div><div>rs.initiate(cfg)</div><div>rs.status()</div></div><div><br/></div><div><br/></div><div>路由服务节点配置和启动</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">touch  /</span>usr/local/zhang/mongodb/logs/route.log</div></div><div><br/></div><div>配置route-27017.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/conf/route-27017.conf &lt;&lt;-'EOF'</div><div>port=27017</div><div>bind_ip=0.0.0.0</div><div>fork=true</div><div>logpath=/usr/local/zhang/mongodb/logs/route.log</div><div>configdb=configsvr/192.168.48.130:17017,192.168.48.130:17018,192.168.48.130:17019</div><div>EOF</div></div><div><br/></div><div>配置路由服务启动脚本</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/start-mongo-route.sh &lt;&lt;-'EOF'<br/></div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongos -f /usr/local/zhang/mongodb/conf/route-27017.conf</div><div>echo &quot;start mongo route...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div><br/></div><div><br/></div><div>chmod 755 /usr/local/zhang/mongodb/start-mongo-route.sh</div></div><div><br/></div><div>配置路由服务关闭脚本</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tee /usr/local/zhang/mongodb/stop-mongo-route.sh &lt;&lt;-'EOF'</div><div>#! /bin/bash</div><div>clear</div><div>/usr/local/zhang/mongodb/bin/mongos --shutdown -f /usr/local/zhang/mongodb/conf/route-27017.conf</div><div>echo &quot;stop mongo route...&quot;</div><div>ps -ef | grep mongodb</div><div>EOF</div><div><br/></div><div><br/></div><div>chmod 755 /usr/local/zhang/mongodb/stop-mongo-route.sh</div></div><div><br/></div><div>mongos（路由）中添加分片节点</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/usr/local/zhang/mongodb/bin/mongo --port 27017</div><div><br/></div><div>sh.status()</div><div>sh.addShard(&quot;shard1/192.168.48.129:37017,192.168.48.129:37018,192.168.48.129:37019&quot;);</div><div>sh.addShard(&quot;shard2/192.168.48.128:47017,192.168.48.128:47018,192.168.48.128:47019&quot;);</div><div>sh.status()</div></div><div><br/></div><div>开启数据库和集合分片(指定片键)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>use admin</div><div>db.runCommand( { enablesharding :&quot;myRangeDB&quot;});</div><div># 为指定集合开启分片功能</div><div>db.runCommand( { shardcollection : &quot;myRangeDB.coll_shard&quot;,key : {_id: 1} } )</div></div><div><br/></div><div>使用hash分片</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>use admin</div><div>db.runCommand({&quot;enablesharding&quot;:&quot;myHashDB&quot;})</div><div>db.runCommand({&quot;shardcollection&quot;:&quot;myHashDB.coll_shard&quot;,&quot;key&quot;:{&quot;_id&quot;:&quot;hashed&quot;}})</div></div><div><br/></div></span>
</div></body></html> 